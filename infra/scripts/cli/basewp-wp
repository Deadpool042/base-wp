#!/usr/bin/env bash
set -euo pipefail

CLI_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPTS_DIR="$(cd "$CLI_DIR/.." && pwd)"

# ------------------------------------------------------------------------------
# Imports (shared)
# ------------------------------------------------------------------------------

# shellcheck source=/dev/null
source "$SCRIPTS_DIR/shared/log.sh"
# shellcheck source=/dev/null
source "$SCRIPTS_DIR/shared/ui.sh"
# shellcheck source=/dev/null
source "$SCRIPTS_DIR/shared/context.sh"

# ------------------------------------------------------------------------------
# Imports (wp core) ‚Äî optionnel
# ------------------------------------------------------------------------------

WP_CORE="$SCRIPTS_DIR/wp/wp.core.sh"
if [[ -f "$WP_CORE" ]]; then
  # shellcheck source=/dev/null
  source "$WP_CORE"
fi

# ------------------------------------------------------------------------------
# Fallbacks (si wp.core.sh pas encore pr√™t)
# ------------------------------------------------------------------------------

if ! declare -F wp_info >/dev/null 2>&1; then
  wp_info() { die "wp_info() manquant: impl√©mente-le dans wp/wp.core.sh"; }
fi

if ! declare -F wp_plugins >/dev/null 2>&1; then
  wp_plugins() { die "wp_plugins() manquant: impl√©mente-le dans wp/wp.core.sh"; }
fi

if ! declare -F wp_db_status >/dev/null 2>&1; then
  wp_db_status() { die "wp_db_status() manquant: impl√©mente-le dans wp/wp.core.sh"; }
fi

# ------------------------------------------------------------------------------
# CLI
# ------------------------------------------------------------------------------

wp_usage() {
  cat <<'EOF'
Usage: basewp wp [command]

Commands:
  info
  plugins
  db
EOF
}

wp_menu_actions() {
  cat <<'EOF'
üß™ WP-CLI info
üß© Plugins list
üóÑÔ∏è  DB status
EOF
}

wp_cmd_info() {
  wp_info
  ui_ok
}

wp_cmd_plugins() {
  wp_plugins
  ui_ok
}

wp_cmd_db_status() {
  wp_db_status
  ui_ok
}

wp_handle_choice() {
  local choice="${1:-}"

  case "$choice" in
    "__back__") exit 0 ;;
    "__quit__") exit 99 ;;
    "__noop__"|"") return 0 ;;

    "üß™ WP-CLI info")    wp_cmd_info ;;
    "üß© Plugins list")   wp_cmd_plugins ;;
    "üóÑÔ∏è  DB status")     wp_cmd_db_status ;;

    *) warn "Choix inconnu: $choice" ;;
  esac
}

wp_menu() {
  while true; do
    local choice
    choice="$(ui_menu "WordPress" "$(wp_menu_actions)")"
    echo  # espace UX sous l'input
    wp_handle_choice "$choice"
  done
}

wp_dispatch() {
  case "${1:-}" in
    -h|--help|help) wp_usage ;;
    info)    wp_cmd_info ;;
    plugins) wp_cmd_plugins ;;
    db)      wp_cmd_db_status ;;
    "")      wp_menu ;;
    *)
      warn "Commande inconnue: ${1:-}"
      echo
      wp_usage
      return 1
      ;;
  esac
}

wp_dispatch "${1:-}"