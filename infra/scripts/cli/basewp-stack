#!/usr/bin/env bash
set -euo pipefail

CLI_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPTS_DIR="$(cd "$CLI_DIR/.." && pwd)"

# ------------------------------------------------------------------------------
# Imports (shared)
# ------------------------------------------------------------------------------

# shellcheck source=/dev/null
source "$SCRIPTS_DIR/shared/log.sh"
# shellcheck source=/dev/null
source "$SCRIPTS_DIR/shared/ui.sh"
# shellcheck source=/dev/null
source "$SCRIPTS_DIR/shared/context.sh"

# ------------------------------------------------------------------------------
# Imports (stack core) ‚Äî optionnel
# ------------------------------------------------------------------------------

STACK_CORE="$SCRIPTS_DIR/stack/stack.core.sh"
if [[ -f "$STACK_CORE" ]]; then
  # shellcheck source=/dev/null
  source "$STACK_CORE"
fi

# ------------------------------------------------------------------------------
# Fallbacks (si stack.core.sh pas encore pr√™t)
# ------------------------------------------------------------------------------

if ! declare -F stack_dc >/dev/null 2>&1; then
  stack_dc() { die "stack_dc() manquant: impl√©mente-le dans stack/stack.core.sh"; }
fi

if ! declare -F stack_logs >/dev/null 2>&1; then
  stack_logs() { die "stack_logs() manquant: impl√©mente-le dans stack/stack.core.sh"; }
fi

# ------------------------------------------------------------------------------
# CLI
# ------------------------------------------------------------------------------

stack_usage() {
  cat <<'EOF'
Usage: basewp stack [command]

Commands:
  up
  down
  ps
  logs
EOF
}

stack_menu_actions() {
  cat <<'EOF'
‚ñ∂Ô∏è  Up
‚èπÔ∏è  Down
üìã Ps
üìú Logs
EOF
}

stack_cmd_up() {
  stack_dc up -d
  ui_ok
}

stack_cmd_down() {
  stack_dc down --remove-orphans
  ui_ok
}

stack_cmd_ps() {
  stack_dc ps
  ui_ok
}

stack_cmd_logs() {
  stack_logs
  ui_ok
}

stack_handle_choice() {
  local choice="${1:-}"

  case "$choice" in
    "__back__") exit 0 ;;
    "__quit__") exit 99 ;;
    "__noop__"|"") return 0 ;;

    "‚ñ∂Ô∏è  Up")   stack_cmd_up ;;
    "‚èπÔ∏è  Down") stack_cmd_down ;;
    "üìã Ps")   stack_cmd_ps ;;
    "üìú Logs") stack_cmd_logs ;;

    *) warn "Choix inconnu: $choice" ;;
  esac
}

stack_menu() {
  while true; do
    local choice
    choice="$(ui_menu "Stack" "$(stack_menu_actions)")"
    echo  # espace UX sous l'input
    stack_handle_choice "$choice"
  done
}

stack_dispatch() {
  case "${1:-}" in
    -h|--help|help) stack_usage ;;
    up)   stack_cmd_up ;;
    down) stack_cmd_down ;;
    ps)   stack_cmd_ps ;;
    logs) stack_cmd_logs ;;
    "")   stack_menu ;;
    *)
      warn "Commande inconnue: ${1:-}"
      echo
      stack_usage
      return 1
      ;;
  esac
}

stack_dispatch "${1:-}"