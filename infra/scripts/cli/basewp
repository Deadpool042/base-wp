#!/usr/bin/env bash
set -euo pipefail

CLI_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPTS_DIR="$(cd "$CLI_DIR/.." && pwd)"

# shared
# shellcheck source=/dev/null
source "$SCRIPTS_DIR/shared/log.sh"
# shellcheck source=/dev/null
source "$SCRIPTS_DIR/shared/ui.sh"
# shellcheck source=/dev/null
source "$SCRIPTS_DIR/shared/context.sh"

basewp_usage() {
  cat <<'EOF'
Usage: basewp <module> [command]

Modules:
  stack
  wp
  project
EOF
}

basewp_show_context() {
  local current profile env

  current="$(ctx_get_current_project_ref 2>/dev/null || true)"
  [[ -n "${current:-}" ]] || current="(aucun)"

  profile="$(ctx_get_profile 2>/dev/null || true)"
  [[ -n "${profile:-}" ]] || profile="(auto)"

  env="$(ctx_get_env_name 2>/dev/null || true)"
  [[ -n "${env:-}" ]] || env="default"

  echo
  echo "ðŸ§© Profil:  ${profile}"
  echo "ðŸ·ï¸  ENV:     ${env}"
  echo "ðŸ“¦ Project:  ${current}"
  echo
}

# Convention:
# - child returns 99 => quit global
run_child() {
  local cmd="$1"; shift || true

  # Ne jamais laisser set -e faire quitter le menu sur un rc != 0
  "$cmd" "$@" || {
    local rc=$?
    [[ $rc -eq 99 ]] && exit 0
    return 0
  }

  return 0
}

basewp_actions() {
  cat <<'EOF'
ðŸ“¦ Stack
ðŸ§© WordPress
ðŸ—‚ï¸  Projects
â„¹ï¸  Contexte (profile/env/current)
EOF
}

basewp_handle_choice() {
  local choice="${1:-}"

  case "$choice" in
    "__quit__") exit 0 ;;
    "__noop__"|"") return 0 ;;

    "ðŸ“¦ Stack")     run_child "$CLI_DIR/basewp-stack" ;;
    "ðŸ§© WordPress") run_child "$CLI_DIR/basewp-wp" ;;
    "ðŸ—‚ï¸  Projects") run_child "$CLI_DIR/basewp-project" ;;

    "â„¹ï¸  Contexte (profile/env/current)")
      basewp_show_context
      ui_pause "Appuie sur EntrÃ©e pour revenir au menuâ€¦"
      ;;

    *)
      warn "Choix inconnu: $choice"
      ;;
  esac
}

basewp_menu() {
  while true; do
    local actions choice
    actions="$(basewp_actions)"
    choice="$(ui_menu "Menu principal" "$actions" true)"
    echo  # espace UX sous l'input fzf
    basewp_handle_choice "$choice"
  done
}

basewp_dispatch_exec() {
  local module="${1:-}"
  shift || true

  case "$module" in
    -h|--help|help) basewp_usage ;;
    stack)   exec "$CLI_DIR/basewp-stack"   "$@" ;;
    wp)      exec "$CLI_DIR/basewp-wp"      "$@" ;;
    project) exec "$CLI_DIR/basewp-project" "$@" ;;
    "")      basewp_menu ;;
    *)
      warn "Module inconnu: ${module:-}"
      echo
      basewp_usage
      return 1
      ;;
  esac
}

basewp_dispatch_exec "${1:-}" "${@:2}"