#!/usr/bin/env bash
set -euo pipefail

CLI_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPTS_DIR="$(cd "$CLI_DIR/.." && pwd)"

# ------------------------------------------------------------------------------
# Imports (shared)
# ------------------------------------------------------------------------------

# shellcheck source=/dev/null
source "$SCRIPTS_DIR/shared/log.sh"
# shellcheck source=/dev/null
source "$SCRIPTS_DIR/shared/ui.sh"
# shellcheck source=/dev/null
source "$SCRIPTS_DIR/shared/context.sh"

# ------------------------------------------------------------------------------
# Imports (project)
# ------------------------------------------------------------------------------

# project.core.sh inclut dÃ©jÃ  project.prompts.sh dans la refacto proposÃ©e.
# Si chez toi il ne lâ€™inclut pas encore, garder le source ci-dessous ne fait pas de mal.
# shellcheck source=/dev/null
source "$SCRIPTS_DIR/project/project.core.sh"
# shellcheck source=/dev/null
source "$SCRIPTS_DIR/project/project.prompts.sh"


[[ -f "$SCRIPTS_DIR/project/project.meta.sh" ]] || die "Fichier manquant: $SCRIPTS_DIR/project/project.meta.sh"

# ------------------------------------------------------------------------------
# Sanity checks / debug
# ------------------------------------------------------------------------------

project_sanity_check() {
  local missing=0
  local fn

  # âœ… on valide lâ€™API "publique" (aliases) plutÃ´t que les internes
  for fn in \
    project_list_projects \
    project_pick_project \
    project_create_project \
    project_edit_project \
    project_delete_project \
    ctx_get_current_project_ref \
    ctx_set_current_project_ref
  do
    if ! declare -F "$fn" >/dev/null 2>&1; then
      warn "API manquante: ${fn}() introuvable."
      missing=1
    fi
  done

  if [[ "$missing" == "1" ]]; then
    warn "Fonctions project_* disponibles:"
    declare -F | awk '{print " - " $3}' | grep '^ - project_' || true
    return 1
  fi

  return 0
}

project_debug_dump() {
  [[ "${DEBUG:-0}" == "1" ]] || return 0
  info "DEBUG: ROOT_DIR=${ROOT_DIR:-<unset>}"
  info "DEBUG: PROJECTS_DIR=${PROJECTS_DIR:-<unset>}"
  info "DEBUG: CURRENT_PROJECT=$(ctx_get_current_project_ref 2>/dev/null || true)"
}

# ------------------------------------------------------------------------------
# CLI
# ------------------------------------------------------------------------------

project_usage() {
  cat <<'EOF'
Usage: basewp project [command]

Commands:
  list        List projects
  current     Show current project
  select      Select current project
  create      Create a new project
  edit        Edit a project
  delete      Delete a project
EOF
}

project_cmd_list() {
  local items
  items="$(project_list_projects || true)"

  if [[ -z "${items:-}" ]]; then
    info "(aucun projet)"
    ui_ok
    return 0
  fi

  echo
  printf "%s\n" "$items"
  echo
  ui_ok
}

project_cmd_current() {
  local project_ref
  project_ref="$(ctx_get_current_project_ref 2>/dev/null || true)"
  [[ -n "${project_ref:-}" ]] || project_ref="(aucun projet courant)"

  info "$project_ref"
  ui_ok
}

project_cmd_select() {
  local selected_ref
  selected_ref="$(project_pick_project || true)"

  case "${selected_ref:-}" in
    ""|"__back__"|"__quit__"|"__noop__") return 0 ;;
  esac

  ctx_set_current_project_ref "$selected_ref"
  ok "Projet courant: $selected_ref"
  ui_ok
}

project_cmd_create() {
  project_create_project
  ui_ok
}

project_cmd_edit() {
  project_edit_project
  ui_ok
}

project_cmd_delete() {
  project_delete_project
  ui_ok
}

# ------------------------------------------------------------------------------
# Menu
# ------------------------------------------------------------------------------

project_menu_actions() {
  cat <<'EOF'
âž• CrÃ©er un projet
ðŸ“‹ Lister les projets
ðŸ“Œ Afficher le projet courant
ðŸŽ¯ SÃ©lectionner un projet courant
ðŸ› ï¸  Ã‰diter un projet
ðŸ—‘ï¸  Supprimer un projet
EOF
}

project_handle_choice() {
  local picked="${1:-}"

  case "$picked" in
    "__back__") exit 0 ;;   # retour menu principal
    "__quit__") exit 99 ;;  # quit global
    ""|"__noop__") return 0 ;;

    "âž• CrÃ©er un projet")               project_cmd_create ;;
    "ðŸ“‹ Lister les projets")             project_cmd_list ;;
    "ðŸ“Œ Afficher le projet courant")     project_cmd_current ;;
    "ðŸŽ¯ SÃ©lectionner un projet courant") project_cmd_select ;;
    "ðŸ› ï¸  Ã‰diter un projet")              project_cmd_edit ;;
    "ðŸ—‘ï¸  Supprimer un projet")           project_cmd_delete ;;

    *) warn "Choix inconnu: $picked" ;;
  esac
}

project_menu() {
  while true; do
    local picked
    picked="$(ui_menu "Projets" "$(project_menu_actions)")"
    echo  # espace UX sous l'input
    project_handle_choice "$picked"
  done
}

# ------------------------------------------------------------------------------
# Dispatch
# ------------------------------------------------------------------------------

project_dispatch() {
  case "${1:-}" in
    -h|--help|help) project_usage; return 0 ;;
    list)    project_cmd_list; return 0 ;;
    current) project_cmd_current; return 0 ;;
    select)  project_cmd_select; return 0 ;;
    create)  project_cmd_create; return 0 ;;
    edit)    project_cmd_edit; return 0 ;;
    delete)  project_cmd_delete; return 0 ;;
    "")      project_menu ;;
    *)
      warn "Commande inconnue: ${1:-}"
      echo
      project_usage
      return 1
      ;;
  esac
}

# ------------------------------------------------------------------------------
# Entrypoint
# ------------------------------------------------------------------------------

project_sanity_check || exit 1
project_debug_dump
project_dispatch "${1:-}"