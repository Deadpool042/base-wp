name: ${PROJECT_NAME:-base-wp}

services:
  traefik:
    image: traefik:v3.2
    container_name: ${PROJECT_NAME:-base-wp}_traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      TRAEFIK_EMAIL: ${TRAEFIK_EMAIL}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/traefik.yml:ro
      - ./traefik/dynamic.yml:/dynamic.yml:ro
      - ./traefik/certs:/certs:ro
      - ./traefik/acme.json:/acme.json
    command:
      - "--configFile=/traefik.yml"
      - "--providers.file.filename=/dynamic.yml"
    networks:
      - basewp

  db:
    image: ${DB_IMAGE:-mysql:8.0}
    container_name: ${PROJECT_NAME:-base-wp}_db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_NAME:-wordpress}
      MYSQL_USER: ${DB_USER:-wp}
      MYSQL_PASSWORD: ${DB_PASSWORD:-wp}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root}
      TZ: ${TZ:-Europe/Paris}
      MYSQL_INITDB_SKIP_TZINFO: "1"
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u$$MYSQL_USER -p$$MYSQL_PASSWORD --silent"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - basewp

  wordpress:
    build:
      context: ./wordpress
      dockerfile: Dockerfile
      args:
        WP_IMAGE_TAG: ${WP_IMAGE_TAG:-6.9-php8.3-fpm}
    image: ${PROJECT_NAME:-base-wp}_wordpress:local
    container_name: ${PROJECT_NAME:-base-wp}_wp
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      WORDPRESS_DB_HOST: ${DB_HOST:-db}:3306
      WORDPRESS_DB_NAME: ${DB_NAME:-wordpress}
      WORDPRESS_DB_USER: ${DB_USER:-wp}
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD:-wp}
      TZ: ${TZ:-Europe/Paris}
      WORDPRESS_TABLE_PREFIX: ${WP_TABLE_PREFIX:-wp_}
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_DEBUG', (bool) ${WP_DEBUG:-0});
        define('WP_DEBUG_LOG', (bool) ${WP_DEBUG_LOG:-0});
        define('WP_DEBUG_DISPLAY', (bool) ${WP_DEBUG_DISPLAY:-0});
        @ini_set('display_errors', (string) ${WP_DEBUG_DISPLAY:-0});
        define('WP_MEMORY_LIMIT', '${WP_MEMORY_LIMIT:-256M}');
        define('WP_MAX_MEMORY_LIMIT', '${WP_MAX_MEMORY_LIMIT:-512M}');
        define('WPLANG', '${WP_LOCALE:-fr_FR}');
    volumes:
      - wp_data:/var/www/html
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x php-fpm > /dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 20s
    networks:
      - basewp

  nginx:
    image: nginx:1.27-alpine
    container_name: ${PROJECT_NAME:-base-wp}_nginx
    restart: unless-stopped
    depends_on:
      wordpress:
        condition: service_healthy
    volumes:
      - wp_data:/var/www/html:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    labels:
      traefik.enable: "true"

      # --- Router HTTPS ---
      traefik.http.routers.wp.rule: "Host(`${SITE_DOMAIN}`) || Host(`${SITE_DOMAIN_WWW}`)"
      traefik.http.routers.wp.entrypoints: "websecure"
      traefik.http.routers.wp.tls: "true"
      traefik.http.services.wp.loadbalancer.server.port: "80"
      traefik.http.routers.wp.tls.domains[0].main: "${SITE_DOMAIN}"
      traefik.http.routers.wp.tls.domains[0].sans: "${SITE_DOMAIN_WWW}"

      # --- Router HTTP -> HTTPS ---
      traefik.http.routers.wp-http.rule: "Host(`${SITE_DOMAIN}`) || Host(`${SITE_DOMAIN_WWW}`)"
      traefik.http.routers.wp-http.entrypoints: "web"
      traefik.http.routers.wp-http.middlewares: "redirect-to-https,sec-headers"
      traefik.http.middlewares.redirect-to-https.redirectscheme.scheme: "https"

      # --- Middlewares security headers ---
      traefik.http.routers.wp.middlewares: "sec-headers"

      traefik.http.middlewares.sec-headers.headers.framedeny: "true"
      traefik.http.middlewares.sec-headers.headers.contenttypenosniff: "true"
      traefik.http.middlewares.sec-headers.headers.referrerpolicy: "no-referrer-when-downgrade"
      traefik.http.middlewares.sec-headers.headers.browserxssfilter: "true"
      traefik.http.middlewares.sec-headers.headers.customResponseHeaders.Permissions-Policy: "geolocation=(), microphone=(), camera=()"

      # HSTS (dev safe via env)
      traefik.http.middlewares.sec-headers.headers.stsSeconds: "${HSTS_SECONDS:-300}"
      traefik.http.middlewares.sec-headers.headers.stsIncludeSubdomains: "${HSTS_INCLUDE_SUBDOMAINS:-false}"
      traefik.http.middlewares.sec-headers.headers.stsPreload: "${HSTS_PRELOAD:-false}"
    networks:
      - basewp

  wpcli:
    image: wordpress:cli
    container_name: ${PROJECT_NAME:-base-wp}_wpcli
    depends_on:
      db:
        condition: service_healthy
      wordpress:
        condition: service_healthy
    environment:
      WORDPRESS_DB_HOST: ${DB_HOST:-db}:3306
      WORDPRESS_DB_NAME: ${DB_NAME:-wordpress}
      WORDPRESS_DB_USER: ${DB_USER:-wp}
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD:-wp}
    volumes:
      - wp_data:/var/www/html
    entrypoint: ["wp"]
    command: ["--info"]
    networks:
      - basewp

volumes:
  db_data:
  wp_data:

networks:
  basewp:
    name: ${PROJECT_NAME:-base-wp}_net